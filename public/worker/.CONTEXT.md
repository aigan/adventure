# Worker Implementation Context

This directory contains the core game logic running in a Web Worker thread.

## Module Overview

### Core Database (`db.mjs`)
Exports Mind, Belief, State classes - the core data structures.

**Index Architecture** (designed for billions of items):
- **Global** (db.mjs): 10 indexes for primary keys, labels, relationships (Mind, State, Belief, Subject)
- **Instance** (mind.mjs): 3 indexes per Mind (_states, _states_by_ground_state, _child_minds)
- **Lazy** (state.mjs): Progressive _subject_index cache (locked states only)
- See inline comments for detailed documentation

### Game World (`world.mjs`)
Defines archetypes (ObjectPhysical, Location, Actor, Player, etc.), traittypes, and initial world state. Exports `Adventure` singleton.

### Channel Communication (`channel.mjs`)
BroadcastChannel server for inspection UI. Message handlers: `query_mind`, `query_state`, `query_belief`, `query_entity`. Uses IndexedDB for ID generation.

### Worker Entry Point (`worker.mjs`)
Message dispatcher. Format: incoming `[cmd, data, ackid]`, outgoing `['ack', ackid, result]`.

### Supporting Modules
- `mind.mjs` - Mind class (nested minds, state tracking)
- `state.mjs` - State class (immutable snapshots, differential updates)
- `archetype.mjs` - Archetype class, static registry, multiple inheritance
- `traittype.mjs` - Type system, static registry (primitives, belief refs, containers)
- `serialize.mjs` - toJSON() (deep) and inspect() (shallow refs)
- `id_sequence.mjs` - IndexedDB-backed ID generation
- `session.mjs` - Session management
- `subject.mjs` - Subject identity with canonical instances

## Key Patterns

**Idealist Model**: System follows nested perspective model - world mind "dreams" reality, NPCs model inner representations of outer world, recursively. See [docs/SPECIFICATION.md](../../docs/SPECIFICATION.md) for conceptual foundation.

**Observable Beliefs vs Prototypes**:
- Observable beliefs: Entities in states with ownership (`in_mind` is Mind) - can use `learn_about()`
- Prototypes: Shared beliefs for inheritance only (`in_mind = null`) - use `bases`, never `learn_about()`
- Archetypes: Global prototypes defined in `world.mjs`

See [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) for detailed patterns and examples.

## Data Flow

1. **Worker receives message** → `worker.mjs` message handler
2. **Dispatcher routes** → appropriate handler function
3. **Handler mutates state** → creates new State via `state.tick()`
4. **Response sent** → `postMessage(['ack', ackid, result])`
5. **State persisted** → new State added to cosmos registry

## Inspection & Debugging

- Use `inspect.html` with `?mind=world` or `?state=123`
- BroadcastChannel communication via `channel.mjs`
- Serialization via `inspect()` for shallow refs
- Deep inspection via `toJSON()` for full expansion

## Integration

- **Client**: `public/lib/message.mjs` - Promise-based async message passing
- **GUI**: `public/lib/gui.mjs` - Topic-based navigation
- **Testing**: `test/helpers.mjs` - setupStandardArchetypes() matches world.mjs

## References

- [docs/SPECIFICATION.md](../../docs/SPECIFICATION.md) - Data model specification
- [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) - Implementation architecture
- [docs/STYLE.md](../../docs/STYLE.md) - Code style guide
- [test/.CONTEXT.md](../../test/.CONTEXT.md) - Test patterns
