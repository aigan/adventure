# Worker Implementation Context

This directory contains the core game logic running in a Web Worker thread.

## Module Overview

### Core Database (`db.mjs`)
Exports Mind, Belief, State classes - the core data structures.

### Game World (`world.mjs`)
Defines archetypes (ObjectPhysical, Location, Actor, Player, etc.), traittypes, and initial world state. Exports `Adventure` singleton.

### Channel Communication (`channel.mjs`)
BroadcastChannel server for inspection UI. Message handlers: `query_mind`, `query_state`, `query_belief`, `query_entity`. Uses IndexedDB for ID generation.

### Worker Entry Point (`worker.mjs`)
Message dispatcher. Format: incoming `[cmd, data, ackid]`, outgoing `['ack', ackid, result]`.

### Supporting Modules
- `archetype.mjs` - Archetype class, multiple inheritance, trait resolution
- `traittype.mjs` - Type system (primitives, belief refs, containers)
- `serialize.mjs` - toJSON() (deep) and inspect() (shallow refs)
- `cosmos.mjs` - Global registries, ID sequences, label lookups
- `id_sequence.mjs` - IndexedDB-backed ID generation
- `session.mjs` - Session management
- `subject.mjs` - Observer pattern for state changes

## Key Patterns

See [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) for detailed patterns and examples.

## Data Flow

1. **Worker receives message** → `worker.mjs` message handler
2. **Dispatcher routes** → appropriate handler function
3. **Handler mutates state** → creates new State via `state.tick()`
4. **Response sent** → `postMessage(['ack', ackid, result])`
5. **State persisted** → new State added to cosmos registry

## Inspection & Debugging

- Use `inspect.html` with `?mind=world` or `?state=123`
- BroadcastChannel communication via `channel.mjs`
- Serialization via `inspect()` for shallow refs
- Deep inspection via `toJSON()` for full expansion

## Integration

- **Client**: `public/lib/message.mjs` - Promise-based async message passing
- **GUI**: `public/lib/gui.mjs` - Topic-based navigation
- **Testing**: `test/helpers.mjs` - setupStandardArchetypes() matches world.mjs

## References

- [docs/SPECIFICATION.md](../../docs/SPECIFICATION.md) - Data model specification
- [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) - Implementation architecture
- [docs/STYLE.md](../../docs/STYLE.md) - Code style guide
- [test/.CONTEXT.md](../../test/.CONTEXT.md) - Test patterns
