# Worker Implementation Context

Core game logic running in Web Worker thread.

## Key Modules

- `cosmos.mjs` - Re-exports, primordial singletons (Logos, Eidos)
- `db.mjs` - Global indexes (10 indexes for id/label/relationships)
- `world.mjs` - Archetypes, traittypes, initial world
- `belief.mjs` - Trait resolution (prioritized: own → derivation → bases)
- `state.mjs` - Immutable snapshots, progressive indexing
- `mind.mjs` - Nested minds, 3 indexes per instance
- `traittype.mjs` - Composition strategies, derivation delegation
- `union_state.mjs` - Multi-parent state composition
- `channel.mjs` - BroadcastChannel for inspection UI
- `worker.mjs` - Message dispatcher

## Critical Patterns

**Trait Resolution**: own traits → Traittype derivation → bases chain (breadth-first). Values immutable per belief. Caching: belief-level, locked only.

**Composition**: Traittypes define strategies via `composable` flag. Arrays deduplicate by Subject reference. Mind traits create UnionState.

**Indexing**: Use indexed lookups only (by id/sid/label). Never iterate DB collections. Progressive caching on locked states.

**Beliefs vs Prototypes**: Observable beliefs have `in_mind` (Mind). Prototypes have `in_mind=null` for inheritance only.

## References

- [SPECIFICATION.md](../../docs/SPECIFICATION.md) - Data model
- [IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) - Architecture details
- [STYLE.md](../../docs/STYLE.md) - Code style
