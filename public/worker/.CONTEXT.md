# Worker Implementation Context

This directory contains the core game logic running in a Web Worker thread.

## Module Overview

### Core Database (`db.mjs`)
Exports Mind, Belief, State classes - the core data structures.

**Index Architecture**: All indexes designed for scalability to billions of items with external DB.
- **Global registries** (10 indexes): Primary keys, labels, and relationships
  - Mind: `mind_by_id`, `mind_by_label`
  - State: `state_by_id`, `state_by_label` (planned feature)
  - Belief: `belief_by_id`, `belief_by_subject`, `belief_by_mind`
  - Subject: `subject_by_sid`, `sid_by_label`, `label_by_sid`
- **Scalability**: All indexes necessary and non-redundant - each serves distinct O(1) or O(n) query patterns
- **See inline comments in db.mjs for detailed index documentation**

### Game World (`world.mjs`)
Defines archetypes (ObjectPhysical, Location, Actor, Player, etc.), traittypes, and initial world state. Exports `Adventure` singleton.

### Channel Communication (`channel.mjs`)
BroadcastChannel server for inspection UI. Message handlers: `query_mind`, `query_state`, `query_belief`, `query_entity`. Uses IndexedDB for ID generation.

### Worker Entry Point (`worker.mjs`)
Message dispatcher. Format: incoming `[cmd, data, ackid]`, outgoing `['ack', ackid, result]`.

### Supporting Modules
- `mind.mjs` - Mind class with instance indexes (3 indexes):
  - `_states`: All states in mind
  - `_states_by_ground_state`: Child mind states by parent state reference
  - `_child_minds`: Direct child minds for hierarchy
- `state.mjs` - State class with lazy caching:
  - `_subject_index`: Progressive subject→belief cache (locked states only)
- `archetype.mjs` - Archetype class, static registry, multiple inheritance
- `traittype.mjs` - Type system, static registry (primitives, belief refs, containers)
- `serialize.mjs` - toJSON() (deep) and inspect() (shallow refs)
- `id_sequence.mjs` - IndexedDB-backed ID generation
- `session.mjs` - Session management
- `subject.mjs` - Subject identity with canonical instances

## Key Patterns

See [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) for detailed patterns and examples.

## Data Flow

1. **Worker receives message** → `worker.mjs` message handler
2. **Dispatcher routes** → appropriate handler function
3. **Handler mutates state** → creates new State via `state.tick()`
4. **Response sent** → `postMessage(['ack', ackid, result])`
5. **State persisted** → new State added to cosmos registry

## Inspection & Debugging

- Use `inspect.html` with `?mind=world` or `?state=123`
- BroadcastChannel communication via `channel.mjs`
- Serialization via `inspect()` for shallow refs
- Deep inspection via `toJSON()` for full expansion

## Integration

- **Client**: `public/lib/message.mjs` - Promise-based async message passing
- **GUI**: `public/lib/gui.mjs` - Topic-based navigation
- **Testing**: `test/helpers.mjs` - setupStandardArchetypes() matches world.mjs

## References

- [docs/SPECIFICATION.md](../../docs/SPECIFICATION.md) - Data model specification
- [docs/IMPLEMENTATION.md](../../docs/IMPLEMENTATION.md) - Implementation architecture
- [docs/STYLE.md](../../docs/STYLE.md) - Code style guide
- [test/.CONTEXT.md](../../test/.CONTEXT.md) - Test patterns
