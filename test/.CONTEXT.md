# Test Suite Context

Comprehensive test coverage (~2,400 lines across 13+ test files) using Mocha test framework.

## Running Tests

```bash
npm test                                  # Run full suite (sets NODE_ENV=test to filter logging)
mocha test/belief.test.mjs                # Run specific file
mocha --grep "archetype"                  # Run tests matching pattern
NODE_ENV=test mocha test/belief.test.mjs  # Run with logging filtered
```

**Note**: `npm test` sets `NODE_ENV=test` which filters runtime logging. Add `NODE_ENV=test` when running mocha directly if you need the same behavior.

## Test Structure

### Core Class Tests
- `mind.test.mjs` - Mind creation, state management, label lookups, nesting, serialization
- `belief.test.mjs` - Belief construction, archetype inheritance, trait validation, serialization
- `state.test.mjs` - State immutability, tick operations, belief queries, inheritance

### System Tests
- `archetype.test.mjs` - Archetype composition, single/multiple inheritance, trait resolution
- `traittype.test.mjs` - Trait type resolution (primitives, belief refs, containers)
- `learn_about.test.mjs` - Cross-mind learning, dereferencing, trait copying
- `declarative_mind_state.test.mjs` - State.resolve_template(), learning specs

### Integration Tests
- `integration.test.mjs` - Full system scenarios matching world.mjs setup
- `inspect.test.mjs` - Inspection UI rendering and navigation
- `channel.test.mjs` - BroadcastChannel communication and serialization
- `registry.test.mjs` - Global registries, ID sequences, label uniqueness

## Test Utilities (`helpers.mjs`)

### `setupStandardArchetypes()`
Creates archetype hierarchy matching `public/worker/world.mjs`.

**Creates**:
- ObjectPhysical (base)
- Location (extends ObjectPhysical)
- PortableObject (extends ObjectPhysical)
- Mental (extends ObjectPhysical)
- Actor (extends ObjectPhysical)
- Player (extends Actor + Mental)

**Use case**: Integration tests and tests requiring full system

### `setupMinimalArchetypes()`
Lightweight setup for focused tests.

**Creates**:
- Base archetype only
- Minimal trait types

**Use case**: Unit tests for specific features

### `createMindWithBeliefs(beliefs)`
Helper for quick mind creation with beliefs.

**Parameters**:
- `beliefs` - Array of belief specs

**Returns**: Mind instance with beliefs added

**Use case**: Setting up test fixtures quickly

## Test Patterns

```javascript
import { setupStandardArchetypes } from './helpers.mjs'

describe('Feature Name', () => {
  beforeEach(() => {
    setupStandardArchetypes()
  })

  it('should do something specific', () => {
    const state1 = new State({ tick: 1 })
    const belief = new Belief({ label: 'test' })

    const state2 = state1.tick({ insert: [belief] })

    assert.notStrictEqual(state1, state2)  // Immutability
    assert.strictEqual(state2.beliefs.size, 1)
  })
})
```

**Conventions**:
- Describe blocks: Feature or class name
- Test names: "should" + specific behavior
- Use descriptive variable names
- Test both success and failure cases

## Requirements

- Every new feature needs tests
- Test edge cases and error conditions
- Use `helpers.mjs` for consistent setup
- Keep tests focused and independent
- All tests must pass before merging

## Debugging

```bash
mocha test/belief.test.mjs              # Run specific file
mocha --grep "archetype composition"    # Filter by pattern
mocha --reporter spec test/*.test.mjs   # Verbose output
```

## References

- [docs/IMPLEMENTATION.md](../docs/IMPLEMENTATION.md) - Implementation architecture
- [docs/STYLE.md](../docs/STYLE.md) - Code quality checklist
- [public/worker/.CONTEXT.md](../public/worker/.CONTEXT.md) - Worker modules
- Mocha docs: https://mochajs.org/
